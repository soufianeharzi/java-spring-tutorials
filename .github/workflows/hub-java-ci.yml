# ============================================================================
# CI/CD Hub - Java CI Caller Template
# ============================================================================
# Copy this file to your repo: .github/workflows/hub-java-ci.yml
# All inputs can be overridden via workflow_dispatch.
#
# For monorepos: set workdir to the subfolder containing your Java project.
#
# NOTE: Update the @ref below to match your desired hub version:
#   - Use @v1 (recommended) for stable releases
#   - Use @main for latest (may have breaking changes)
#
# To run on push/PR, add triggers and hardcode your preferred defaults.
# ============================================================================

name: "Hub: Java CI"

# ============================================================================
# DISPATCH INPUTS: Tool toggles only (booleans)
# THRESHOLDS: Set in .ci-hub.yml or edit defaults below
# See ADR-0024 for rationale (GitHub 25-input limit)
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      # ---- Essential Settings ----
      java_version:
        description: 'Java version'
        type: string
        default: '21'
      build_tool:
        description: 'Build tool (maven or gradle)'
        type: string
        default: 'maven'
      workdir:
        description: 'Working directory (for monorepos)'
        type: string
        default: '.'
      hub_correlation_id:
        description: 'Correlation ID (set by orchestrator)'
        type: string
        default: ''

      # ---- Tool Toggles (booleans only) ----
      run_jacoco:
        description: 'Run JaCoCo coverage'
        type: boolean
        default: true
      run_checkstyle:
        description: 'Run Checkstyle'
        type: boolean
        default: true
      run_spotbugs:
        description: 'Run SpotBugs'
        type: boolean
        default: true
      run_owasp:
        description: 'Run OWASP Dependency Check'
        type: boolean
        default: true
      use_nvd_api_key:
        description: 'Use NVD API key for faster OWASP scans'
        type: boolean
        default: true
      run_pmd:
        description: 'Run PMD'
        type: boolean
        default: true
      run_pitest:
        description: 'Run PITest mutation testing'
        type: boolean
        default: true
      run_jqwik:
        description: 'Run jqwik property-based testing'
        type: boolean
        default: false
      run_semgrep:
        description: 'Run Semgrep SAST'
        type: boolean
        default: false
      run_trivy:
        description: 'Run Trivy container scan'
        type: boolean
        default: false
      run_codeql:
        description: 'Run CodeQL analysis'
        type: boolean
        default: false

      # ---- Threshold Override ----
      threshold_overrides_yaml:
        description: 'YAML string with threshold overrides'
        type: string
        default: ''

      # ---- NOTE: Thresholds not in dispatch ----
      # To customize thresholds, edit the defaults in the 'with:' block below
      # or set them in your .ci-hub.yml (see docs/guides/ONBOARDING.md)

# Required permissions for reusable workflow features
permissions:
  contents: read
  security-events: write  # For CodeQL (must be declared even if disabled)
  actions: read

jobs:
  ci:
    uses: jguida941/ci-cd-hub/.github/workflows/java-ci.yml@v1
    with:
      # ---- From dispatch inputs ----
      java_version: ${{ inputs.java_version }}
      build_tool: ${{ inputs.build_tool }}
      workdir: ${{ inputs.workdir }}
      hub_correlation_id: ${{ inputs.hub_correlation_id }}

      # ---- Tool toggles (from dispatch) ----
      run_jacoco: ${{ inputs.run_jacoco }}
      run_checkstyle: ${{ inputs.run_checkstyle }}
      run_spotbugs: ${{ inputs.run_spotbugs }}
      run_owasp: ${{ inputs.run_owasp }}
      use_nvd_api_key: ${{ inputs.use_nvd_api_key }}
      run_pmd: ${{ inputs.run_pmd }}
      run_pitest: ${{ inputs.run_pitest }}
      run_jqwik: ${{ inputs.run_jqwik }}
      run_semgrep: ${{ inputs.run_semgrep }}
      run_trivy: ${{ inputs.run_trivy }}
      run_codeql: ${{ inputs.run_codeql }}

      # ---- Threshold Override ----
      threshold_overrides_yaml: ${{ inputs.threshold_overrides_yaml }}

      # ---- Thresholds (edit these defaults or set in .ci-hub.yml) ----
      coverage_min: 70
      mutation_score_min: 70
      owasp_cvss_fail: 7
      max_critical_vulns: 0
      max_high_vulns: 0
      max_semgrep_findings: 0
      max_pmd_violations: 0
      max_checkstyle_errors: 0
      max_spotbugs_bugs: 0

      # ---- Metadata (edit if needed) ----
      artifact_prefix: ''
      retention_days: 30
    secrets: inherit
