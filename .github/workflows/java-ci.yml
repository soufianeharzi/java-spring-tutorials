name: Java CI

on:
  push:
    branches: [ main, develop, 'tutorial-*' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java: [ '17', '21' ]

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      - name: Cache Maven repository
        uses: actions/cache@v5
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build and test all modules
        run: ./mvnw -B -ntp verify 2>&1 | tee build-output.log

      - name: Run Checkstyle
        run: ./mvnw -B -ntp checkstyle:check

      - name: Run SpotBugs
        run: ./mvnw -B -ntp compile spotbugs:check

      - name: Generate Build Summary
        if: always()
        run: |
          echo "## Build & Test Summary (Java ${{ matrix.java }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Module Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Description | Spring Boot |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 01-spring-hello-rest | REST API basics with @RestController | 4.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| 02-spring-scheduling-tasks | Scheduled tasks with @Scheduled | 4.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| 03-quote-service | Quote provider API | 4.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| 03-spring-consuming-rest | REST client with RestClient | 4.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Test Results by Module" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Tests | Passed | Failed | Skipped |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # Parse test results for each module
          for module in "rest_service" "scheduling-tasks" "quote-service" "consuming-rest"; do
            # Find test line for this module's test class
            test_line=$(grep "Tests run:.*in com.example" build-output.log | grep -i "${module//-/}" | head -1 || echo "")
            if [ -n "$test_line" ]; then
              run=$(echo "$test_line" | grep -oE "Tests run: [0-9]+" | grep -oE "[0-9]+" || echo "0")
              fail=$(echo "$test_line" | grep -oE "Failures: [0-9]+" | grep -oE "[0-9]+" || echo "0")
              skip=$(echo "$test_line" | grep -oE "Skipped: [0-9]+" | grep -oE "[0-9]+" || echo "0")
              pass=$((run - fail))
              echo "| $module | $run | $pass | $fail | $skip |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          # Total tests
          total_run=$(grep "Tests run:" build-output.log | grep -oE "Tests run: [0-9]+" | grep -oE "[0-9]+" | awk '{s+=$1} END {print s}')
          total_fail=$(grep "Failures:" build-output.log | grep -oE "Failures: [0-9]+" | grep -oE "[0-9]+" | awk '{s+=$1} END {print s}')
          echo "**Total: ${total_run:-0} tests, ${total_fail:-0} failures**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkstyle | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| SpotBugs | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| JaCoCo Coverage | Generated |" >> $GITHUB_STEP_SUMMARY

      - name: Set up Python
        if: matrix.java == '17'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate QA metrics summary
        if: matrix.java == '17'
        env:
          UPDATE_BADGES: ${{ github.ref == 'refs/heads/main' && 'true' || 'false' }}
          MATRIX_JAVA: ${{ matrix.java }}
          MATRIX_OS: ${{ runner.os }}
        run: python scripts/ci_metrics_summary.py

      - name: Commit updated badges
        if: matrix.java == '17' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git status --porcelain badges | grep -q .; then
            echo "Badge files changed, committing..."
            git add badges/*.json badges/*/*.json
            git commit -m "Update badges from CI [skip ci]" || exit 0
            git push
          else
            echo "No badge changes to commit."
          fi

  # PITest runs only on main branch (slower)
  mutation-test:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven repository
        uses: actions/cache@v5
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run PITest mutation testing (03 modules only)
        run: |
          ./mvnw -B -ntp test org.pitest:pitest-maven:mutationCoverage \
            -pl 03-quote-service,03-spring-consuming-rest 2>&1 | tee pitest-output.log

      - name: Generate Mutation Test Summary
        if: always()
        run: |
          echo "## Mutation Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PITest mutation testing validates test quality by introducing code mutations and verifying tests detect them." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Results by Module" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Line Coverage | Mutations | Killed | Mutation Score |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------------|-----------|--------|----------------|" >> $GITHUB_STEP_SUMMARY

          # Extract stats for quote-service (look for the statistics line)
          qs_line=$(grep -A2 "Building quote-service" pitest-output.log | head -1 || echo "")
          qs_stats=$(sed -n '/Building quote-service/,/BUILD SUCCESS\|Building consuming-rest/p' pitest-output.log | grep "Generated.*mutations Killed" | tail -1 || echo "")
          qs_coverage=$(sed -n '/Building quote-service/,/BUILD SUCCESS\|Building consuming-rest/p' pitest-output.log | grep "Line Coverage" | tail -1 || echo "")

          if [ -n "$qs_stats" ]; then
            generated=$(echo "$qs_stats" | grep -oE "Generated [0-9]+" | grep -oE "[0-9]+" || echo "0")
            killed=$(echo "$qs_stats" | grep -oE "Killed [0-9]+" | grep -oE "[0-9]+" || echo "0")
            pct=$(echo "$qs_stats" | grep -oE "\([0-9]+%\)" | grep -oE "[0-9]+" || echo "0")
            line_cov=$(echo "$qs_coverage" | grep -oE "[0-9]+/[0-9]+ \([0-9]+%\)" || echo "N/A")
            echo "| 03-quote-service | $line_cov | $generated | $killed | ${pct}% |" >> $GITHUB_STEP_SUMMARY
          fi

          # Extract stats for consuming-rest
          cr_stats=$(sed -n '/Building consuming-rest/,/BUILD SUCCESS/p' pitest-output.log | grep "Generated.*mutations Killed" | tail -1 || echo "")
          cr_coverage=$(sed -n '/Building consuming-rest/,/BUILD SUCCESS/p' pitest-output.log | grep "Line Coverage" | tail -1 || echo "")

          if [ -n "$cr_stats" ]; then
            generated=$(echo "$cr_stats" | grep -oE "Generated [0-9]+" | grep -oE "[0-9]+" || echo "0")
            killed=$(echo "$cr_stats" | grep -oE "Killed [0-9]+" | grep -oE "[0-9]+" || echo "0")
            pct=$(echo "$cr_stats" | grep -oE "\([0-9]+%\)" | grep -oE "[0-9]+" || echo "0")
            line_cov=$(echo "$cr_coverage" | grep -oE "[0-9]+/[0-9]+ \([0-9]+%\)" || echo "N/A")
            echo "| 03-consuming-rest | $line_cov | $generated | $killed | ${pct}% |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Required | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mutation Score | >=70% | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Line Coverage | >=75% | Passed |" >> $GITHUB_STEP_SUMMARY

  # OWASP runs only on main branch (slower, requires NVD data)
  security-check:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven repository
        uses: actions/cache@v5
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Cache NVD data
        uses: actions/cache@v5
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: ${{ runner.os }}-nvd-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-nvd-

      - name: Verify OSS Index secrets
        run: |
          if [ -z "${{ secrets.OSS_INDEX_USERNAME }}" ]; then
            echo "WARNING: OSS_INDEX_USERNAME secret is empty or not set"
          else
            echo "OSS_INDEX_USERNAME is set (length: ${#OSS_USER})"
          fi
          if [ -z "${{ secrets.OSS_INDEX_TOKEN }}" ]; then
            echo "WARNING: OSS_INDEX_TOKEN secret is empty or not set"
          else
            echo "OSS_INDEX_TOKEN is set"
          fi
        env:
          OSS_USER: ${{ secrets.OSS_INDEX_USERNAME }}

      - name: Run OWASP Dependency-Check
        env:
          OSS_USER: ${{ secrets.OSS_INDEX_USERNAME }}
          OSS_PASS: ${{ secrets.OSS_INDEX_TOKEN }}
        run: ./mvnw -B -ntp org.owasp:dependency-check-maven:aggregate -DossIndexUsername="$OSS_USER" -DossIndexPassword="$OSS_PASS"

      - name: Generate Security Summary
        if: always()
        run: |
          echo "## Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "OWASP Dependency-Check scans all dependencies for known vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fail Build CVSS | >=7 (High/Critical) |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Sources | NVD + Sonatype OSS Index |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No high/critical vulnerabilities detected in dependencies." >> $GITHUB_STEP_SUMMARY
